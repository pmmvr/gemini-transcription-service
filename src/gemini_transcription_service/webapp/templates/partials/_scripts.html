<script>
    const uploadForm = document.getElementById('uploadForm');
    const fileInput = document.getElementById('fileInput');
    const submitButton = document.getElementById('submitButton');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const originalFilePath = "{% if original_filepath %}{{ original_filepath }}{% else %}{% endif %}";
    const flashMessages = document.getElementById('flash-messages');
    const fileInfoDisplay = document.getElementById('fileInfoDisplay');
    const selectedFileName = document.getElementById('selectedFileName');
    const clearFileBtn = document.getElementById('clearFileBtn');
    const durationWarningDiv = document.getElementById('durationWarning');
    const LONG_AUDIO_THRESHOLD_MINUTES = 50;
    
    // Auto-hide flash messages after 5 seconds if they're showing
    if (flashMessages) {
        setTimeout(() => {
            flashMessages.style.transition = 'opacity 0.5s ease-out';
            flashMessages.style.opacity = '0';
            setTimeout(() => {
                flashMessages.style.display = 'none';
            }, 500);
        }, 5000);
    }
    
    // Show file info immediately after selection
    fileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            const file = this.files[0];
            const fileName = file.name;
            const fileSize = (file.size / (1024 * 1024)).toFixed(2); // Size in MB
            
            selectedFileName.textContent = `${fileName} (${fileSize} MB)`;
            fileInfoDisplay.classList.remove('hidden');
            durationWarningDiv.classList.add('hidden');

            // Check audio duration client-side
            if (file.type.startsWith('audio/')) {
                const audio = document.createElement('audio');
                audio.preload = 'metadata';
                audio.onloadedmetadata = function() {
                    window.URL.revokeObjectURL(audio.src);
                    const durationSeconds = audio.duration;
                    if (durationSeconds) {
                        const durationMinutes = durationSeconds / 60;
                        console.log(`Client-side detected duration: ${durationMinutes.toFixed(2)} minutes`);
                        if (durationMinutes > LONG_AUDIO_THRESHOLD_MINUTES) {
                            durationWarningDiv.classList.remove('hidden');
                        } else {
                            durationWarningDiv.classList.add('hidden');
                        }
                    }
                };
                audio.onerror = function() {
                    console.warn("Client-side error reading audio metadata.");
                    durationWarningDiv.classList.add('hidden');
                };
                audio.src = URL.createObjectURL(file);
            } else {
                durationWarningDiv.classList.add('hidden');
            }
            
            // Hide flash messages when a new file is selected
            if (flashMessages) {
                flashMessages.style.display = 'none';
            }
        } else {
            fileInfoDisplay.classList.add('hidden');
        }
    });
    
    // Clear file selection
    clearFileBtn.addEventListener('click', function() {
        fileInput.value = '';
        fileInfoDisplay.classList.add('hidden');
        durationWarningDiv.classList.add('hidden');
    });
    
    // Form submission handler
    uploadForm.addEventListener('submit', function(event) {
        if (fileInput.files.length === 0) {
            alert('Please select a file first.');
            event.preventDefault();
            return;
        }
        
        // Hide file info display during processing
        fileInfoDisplay.classList.add('hidden');
        
        submitButton.disabled = true;
        submitButton.textContent = 'Uploading...';
        loadingIndicator.classList.remove('hidden');
        
        // Clear flash messages on new upload
        if (flashMessages) {
            flashMessages.style.display = 'none';
        }
    });

    // Init on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Check if we have a successful transcription result
        const transcriptContent = document.getElementById('transcript-content');
        
        // If we have a transcript result, hide any success messages
        if (transcriptContent && flashMessages) {
            // Check if flash messages contain only success messages (not errors)
            const errorMessages = flashMessages.querySelectorAll('.bg-red-100');
            if (errorMessages.length === 0) {
                // No error messages, so hide all flash messages
                flashMessages.style.display = 'none';
            }
        }
        
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // Tab switching
        if (tabs.length > 0) {
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Update tabs
                    tabs.forEach(t => {
                        t.classList.remove('active', 'bg-white', 'font-medium');
                        t.classList.add('bg-gray-100', 'font-normal');
                        t.setAttribute('aria-selected', 'false');
                    });
                    this.classList.remove('bg-gray-100', 'font-normal');
                    this.classList.add('active', 'bg-white', 'font-medium');
                    this.setAttribute('aria-selected', 'true');
                    
                    // Update content
                    tabContents.forEach(content => {
                        content.classList.add('hidden');
                        content.classList.remove('active');
                        if (content.id === `${tabId}-tab`) {
                            content.classList.remove('hidden');
                            content.classList.add('active');
                        }
                    });
                });
            });
        }
        
        // Speaker replacement
        const speakerList = document.getElementById('speaker-list');
        const applyButton = document.getElementById('apply-speaker-names');
        const downloadModifiedBtn = document.getElementById('download-modified');
        
        if (transcriptContent) {
            const text = transcriptContent.value;
            const speakerRegex = /\[(Speaker \d+)/g;
            const uniqueSpeakers = new Set();
            
            // Extract speakers
            let match;
            while ((match = speakerRegex.exec(text)) !== null) {
                uniqueSpeakers.add(match[1]);
            }
            
            // Create UI elements
            Array.from(uniqueSpeakers).sort().forEach(speaker => {
                const speakerItem = document.createElement('div');
                speakerItem.className = 'p-3 bg-white rounded border border-gray-200';
                
                const label = document.createElement('label');
                label.textContent = speaker;
                label.className = 'block mb-2 font-medium text-gray-700';
                
                const input = document.createElement('input');
                input.type = 'text';
                input.placeholder = 'Enter real name';
                input.dataset.speaker = speaker;
                input.className = 'w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500';
                
                speakerItem.appendChild(label);
                speakerItem.appendChild(input);
                speakerList.appendChild(speakerItem);
            });
            
            // Apply speaker replacements
            applyButton.addEventListener('click', function() {
                let modifiedText = transcriptContent.value;
                const inputs = speakerList.querySelectorAll('input');
                
                inputs.forEach(input => {
                    const speaker = input.dataset.speaker;
                    const realName = input.value.trim();
                    
                    if (realName) {
                        const regex = new RegExp(`\[${speaker}`, 'g');
                        modifiedText = modifiedText.replace(regex, `[${realName}`);
                    }
                });
                
                transcriptContent.value = modifiedText;
            });
            
            // Download handler
            if (downloadModifiedBtn) {
                downloadModifiedBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    const blob = new Blob([transcriptContent.value], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    
                    a.href = url;
                    a.download = 'modified_transcript.txt';
                    document.body.appendChild(a);
                    a.click();
                    
                    // Cleanup
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 100);
                });
            }
            
            // Summary generation
            const generateSummaryBtn = document.getElementById('generate-summary-btn');
            const summarySection = document.getElementById('summary-section');
            const summaryContent = document.getElementById('summary-content');
            const summaryLoading = document.getElementById('summary-loading');
            const downloadSummaryBtn = document.getElementById('download-summary');
            const feedbackBtn = document.getElementById('feedback-btn');
            const feedbackPanel = document.getElementById('feedback-panel');
            const summaryFeedback = document.getElementById('summary-feedback');
            const regenerateBtn = document.getElementById('regenerate-btn');
            const cancelFeedbackBtn = document.getElementById('cancel-feedback-btn');
            const regenerateLoading = document.getElementById('regenerate-loading');
            const copySummaryBtn = document.getElementById('copy-summary-btn');
            
            // Copy to clipboard
            if (copySummaryBtn) {
                copySummaryBtn.addEventListener('click', function() {
                    if (summaryContent.value) {
                        navigator.clipboard.writeText(summaryContent.value)
                            .then(() => {
                                // Visual feedback
                                const originalText = this.textContent;
                                this.textContent = 'Copied!';
                                this.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                                this.classList.add('bg-green-600', 'hover:bg-green-700');
                                
                                setTimeout(() => {
                                    this.textContent = originalText;
                                    this.classList.remove('bg-green-600', 'hover:bg-green-700');
                                    this.classList.add('bg-gray-600', 'hover:bg-gray-700');
                                }, 2000);
                            })
                            .catch(err => {
                                console.error('Failed to copy text: ', err);
                                alert('Failed to copy to clipboard');
                            });
                    }
                });
            }
            
            // Generate summary
            if (generateSummaryBtn) {
                generateSummaryBtn.addEventListener('click', function() {
                    // Get mappings
                    const speakerMapping = {};
                    const inputs = speakerList.querySelectorAll('input');
                    
                    inputs.forEach(input => {
                        const speaker = input.dataset.speaker;
                        const realName = input.value.trim();
                        
                        if (realName) {
                            speakerMapping[speaker] = realName;
                        }
                    });
                    
                    // UI: loading
                    summaryLoading.classList.remove('hidden');
                    generateSummaryBtn.disabled = true;
                    generateSummaryBtn.textContent = 'Generating...';
                    
                    // API call
                    fetch('/generate-summary', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            transcript: transcriptContent.value,
                            speaker_mapping: speakerMapping,
                            input_path: originalFilePath
                        }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        // Reset UI
                        summaryLoading.classList.add('hidden');
                        generateSummaryBtn.disabled = false;
                        generateSummaryBtn.textContent = 'Generate Meeting Summary';
                        
                        if (data.success) {
                            // Show summary
                            summarySection.classList.remove('hidden');
                            summaryContent.value = data.summary;
                            
                            // Switch tab
                            document.querySelector('.tab[data-tab="summary"]').click();
                            
                            // Setup download
                            if (downloadSummaryBtn && data.download_filename) {
                                downloadSummaryBtn.addEventListener('click', function(e) {
                                    e.preventDefault();
                                    window.location.href = `/download/${data.download_filename}`;
                                });
                            }
                        } else {
                            alert('Failed to generate summary: ' + (data.error || 'Unknown error'));
                        }
                    })
                    .catch(error => {
                        // Error handling
                        summaryLoading.classList.add('hidden');
                        generateSummaryBtn.disabled = false;
                        generateSummaryBtn.textContent = 'Generate Meeting Summary';
                        alert('Error: ' + error);
                    });
                });
            }
            
            // Show feedback panel
            if (feedbackBtn) {
                feedbackBtn.addEventListener('click', function() {
                    feedbackPanel.classList.remove('hidden');
                    summaryFeedback.focus();
                });
            }
            
            // Cancel feedback
            if (cancelFeedbackBtn) {
                cancelFeedbackBtn.addEventListener('click', function() {
                    feedbackPanel.classList.add('hidden');
                    summaryFeedback.value = '';
                });
            }
            
            // Regenerate with feedback
            if (regenerateBtn) {
                regenerateBtn.addEventListener('click', function() {
                    const feedback = summaryFeedback.value.trim();
                    
                    if (!feedback) {
                        alert('Please provide feedback for regenerating the summary.');
                        return;
                    }
                    
                    // UI: loading
                    regenerateLoading.classList.remove('hidden');
                    regenerateBtn.disabled = true;
                    regenerateBtn.textContent = 'Regenerating...';
                    
                    // API call
                    fetch('/regenerate-summary', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            original_transcript: transcriptContent.value,
                            previous_summary: summaryContent.value,
                            feedback: feedback,
                            input_path: originalFilePath
                        }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        // Reset UI
                        regenerateLoading.classList.add('hidden');
                        regenerateBtn.disabled = false;
                        regenerateBtn.textContent = 'Regenerate Summary';
                        
                        if (data.success) {
                            // Update summary
                            summaryContent.value = data.summary;
                            
                            // Hide panel
                            feedbackPanel.classList.add('hidden');
                            summaryFeedback.value = '';
                            
                            // Update download
                            if (downloadSummaryBtn && data.download_filename) {
                                downloadSummaryBtn.href = `/download/${data.download_filename}`;
                            }
                        } else {
                            alert('Failed to regenerate summary: ' + (data.error || 'Unknown error'));
                        }
                    })
                    .catch(error => {
                        // Error handling
                        regenerateLoading.classList.add('hidden');
                        regenerateBtn.disabled = false;
                        regenerateBtn.textContent = 'Regenerate Summary';
                        alert('Error: ' + error);
                    });
                });
            }
        }
    });
</script> 